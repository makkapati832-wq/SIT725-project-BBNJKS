<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts for Modern Look -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
     <link rel="stylesheet" href="style.css">

</head>
<body>

    <div id="navbar-placeholder"></div>

    <div class="dashboard-container">
        
        <!-- HEADER SECTION: Welcome & Image -->
        <div class="welcome-section">
            <div class="welcome-text">
                <h1>Student <span>Dashboard</span></h1>
                <p id="welcome-msg">Loading user info...</p>
            </div>
            <!-- Working Illustration (Studying) -->
            <img src="https://raw.githubusercontent.com/sefyudem/Responsive-Login-Form/master/img/bg.svg" 
                 alt="Studying Illustration" 
                 class="header-img">
        </div>

        <div class="row g-4">
            <!-- LEFT COLUMN: Mark Attendance -->
            <div class="col-lg-5 col-md-12">
                <div class="glass-card">
                    <div class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        Mark Attendance
                    </div>
                    <p class="text-secondary mb-4">Enter the Session ID provided by your teacher to mark your presence.</p>
                    
                    <form id="attendanceForm">
                        <div class="mb-4">
                            <label class="form-label text-muted fw-bold small text-uppercase">Session ID</label>
                            <input type="text" id="sessionId" class="form-control" placeholder="e.g. 64f2a..." required>
                        </div>
                        <button class="btn btn-primary-custom w-100" type="submit">Submit Attendance</button>
                    </form>
                    
                    <div id="attendance-status"></div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Available Classes -->
            <div class="col-lg-7 col-md-12">
                <div class="glass-card">
                    <div class="card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book-open"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 1-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                        Enrolled Classes
                    </div>
                    <!-- This container will now scroll if classes exceed the height -->
                    <div id="classes-list">
                        <p class="text-center text-muted py-4">Loading your classes...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Axios & Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="app.js"></script>

    <!-- Functionality Script -->
    <script>
        // 1. Check Auth (Using your existing Auth object)
        const user = Auth.checkAuth('student');
        if(user) {
            document.getElementById('welcome-msg').innerText = `Welcome back, ${user.name}! Ready to learn?`;
            fetchClasses();
        }

        // 2. Fetch Classes
        async function fetchClasses() {
            try {
                const { data } = await axios.get(`${API_BASE_URL}/classes`);
                const listContainer = document.getElementById('classes-list');
                
                if (data.length === 0) {
                    listContainer.innerHTML = '<div class="text-center p-4 text-muted">No classes available yet.</div>';
                    return;
                }

                let html = '';
                data.forEach(cls => {
                    html += `
                        <div class="class-list-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${cls.classCode} - ${cls.className}</strong>
                                    <small>${cls.description || 'No description provided'}</small>
                                </div>
                                <span class="badge bg-light text-primary rounded-pill">Active</span>
                            </div>
                        </div>
                    `;
                });
                listContainer.innerHTML = html;
            } catch (err) {
                console.error("Failed to fetch classes");
                document.getElementById('classes-list').innerHTML = '<p class="text-danger text-center">Failed to load classes.</p>';
            }
        }

        // 3. Mark Attendance
        document.getElementById('attendanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const sessionId = document.getElementById('sessionId').value.trim();
            const statusDiv = document.getElementById('attendance-status');
            
            statusDiv.innerHTML = '<p class="text-muted text-center"><small>Processing...</small></p>'; 

            try {
                await axios.post(`${API_BASE_URL}/attendance/mark`, {
                    studentId: user.id,
                    sessionId: sessionId,
                });
                statusDiv.innerHTML = '<p class="text-success text-center">✅ Attendance Marked Successfully!</p>';
                document.getElementById('sessionId').value = '';
            } catch (err) {
                let msg = "Failed to mark attendance.";
                if (err.response) {
                    if (err.response.status === 400) msg = err.response.data.message;
                    else if (err.response.data.error?.includes("Cast to ObjectId")) msg = "Invalid Session ID format.";
                }
                statusDiv.innerHTML = `<p class="text-danger text-center">❌ ${msg}</p>`;
            }
        });
    </script>
</body>
</html>